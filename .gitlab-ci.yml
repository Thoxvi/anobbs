stages:
  - build
  - deploy

build:
  image: docker:19.03.12
  stage: build
  tags:
    - shared
  services:
    - name: docker:19.03.12-dind
      command: [ "--insecure-registry=gitlab.thoxvi.com:4567" ]
  variables:
    DOCKER_TLS_CERTDIR: ''
  script:
    - FULL_TAG=$CI_REGISTRY_IMAGE:latest
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD http://gitlab.thoxvi.com:4567
    - docker build -t $FULL_TAG .
    - docker push $FULL_TAG
    - docker logout $CI_REGISTRY

deploy:
  stage: deploy
  image:
    name: dtzar/helm-kubectl:3.6.0
    entrypoint: [ "" ]
  environment:
    name: production
  tags:
    - shared
  script:
    - kubectl version
    - helm version
    - helm repo add bitnami https://charts.bitnami.com/bitnami
    - set +e
    - |
      helm install
        --create-namespace
        -n $KUBE_NAMESPACE
        mongo bitnami/mongodb
        --set persistence.enabled=true,
              persistence.size=5Gi,
              global.storageClass=fast,
              global.namespaceOverride=$KUBE_NAMESPACE | true
    - set -e
    - cd .k8s
    - kubectl apply -f anobbs-deployment.yml -n $KUBE_NAMESPACE
